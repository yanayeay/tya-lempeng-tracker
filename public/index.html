<!DOCTYPE html>
<html lang="en">
<head>

  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="theme-color" content="#f59e0b" />
  <title>Tya's Lempeng Financial Tracker</title>

  <!-- PWA Features -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="apple-mobile-web-app-title" content="Lempeng Tracker">

  <!-- Load React and dependencies -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/lucide-react@0.263.1/dist/umd/lucide-react.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/@supabase/supabase-js@2.38.4/dist/umd/supabase.js"></script>

  <!-- Babel for JSX transformation -->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <style>
        body { margin: 0; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; }
        * { box-sizing: border-box; }
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #888; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #555; }
    </style>
</head>
<body>
<div id="root">
  <div class="min-h-screen bg-gray-100 flex items-center justify-center">
    <div class="text-center">
      <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-yellow-600 mx-auto mb-4"></div>
      <p class="text-gray-600">Loading Tya's Lempeng Tracker...</p>
      <p class="text-xs text-gray-500 mt-2">Connecting to secure database...</p>
    </div>
  </div>
</div>

<script type="text/babel">
        // üî• REPLACE THESE WITH YOUR SUPABASE DETAILS
        const SUPABASE_URL = 'https://ymtxvkpdcwxumwlzpofe.supabase.co'; // Replace with your URL
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InltdHh2a3BkY3d4dW13bHpwb2ZlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUwODExOTIsImV4cCI6MjA3MDY1NzE5Mn0.8Q23eZALnVTlG-gw4olu1byRjp3MSTiJGsS4HSi-cqE'; // Replace with your key

        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        const { useState, useEffect } = React;
        const { Plus, Edit3, Trash2, DollarSign, TrendingUp, TrendingDown, Settings, Filter, X, Calendar, Tag, Lock, LogOut, Globe, BarChart3, CreditCard, Shield, Users, Database, Cloud } = lucideReact;

        const PasswordProtection = ({ onAuthenticated }) => {
          const [username, setUsername] = useState('');
          const [password, setPassword] = useState('');
          const [error, setError] = useState('');
          const [loading, setLoading] = useState(false);

          const handleSubmit = async () => {
            setLoading(true);
            setError('');

            try {
              const { data, error } = await supabase
                .from('users')
                .select('*')
                .eq('username', username)
                .eq('password', password)
                .eq('active', true)
                .single();

              if (error || !data) {
                setError('Invalid username or password. Please try again.');
                setPassword('');
              } else {
                // Update last login
                await supabase
                  .from('users')
                  .update({ last_login: new Date().toISOString() })
                  .eq('id', data.id);

                onAuthenticated(data);
              }
            } catch (err) {
              setError('Connection error. Please try again.');
            }

            setLoading(false);
          };

          return (
            <div className="min-h-screen bg-gradient-to-br from-yellow-50 to-red-50 flex items-center justify-center p-4">
              <div className="bg-white rounded-lg shadow-xl p-8 w-full max-w-md">
                <div className="text-center mb-6">
                  <div className="mx-auto w-20 h-20 bg-yellow-100 rounded-full flex items-center justify-center mb-4">
                    <Database className="h-10 w-10 text-yellow-600" />
                  </div>
                  <h1 className="text-2xl font-bold text-gray-900">Tya's Lempeng Financial Tracker</h1>
                  <p className="text-gray-600 mt-2">üåê Powered by Cloud Database</p>
                  <p className="text-sm text-gray-500 mt-1">Secure ‚Ä¢ Multi-User ‚Ä¢ Always Backed Up</p>
                </div>

                <div className="space-y-4">
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-2">Username</label>
                    <input
                      type="text"
                      value={username}
                      onChange={(e) => setUsername(e.target.value)}
                      className="w-full border border-gray-300 rounded-lg px-4 py-3 focus:ring-2 focus:ring-yellow-500 focus:border-transparent text-center text-lg"
                      placeholder="Enter your username"
                      disabled={loading}
                      autoFocus
                    />
                  </div>

                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-2">Password</label>
                    <input
                      type="password"
                      value={password}
                      onChange={(e) => setPassword(e.target.value)}
                      onKeyPress={(e) => e.key === 'Enter' && !loading && handleSubmit()}
                      className="w-full border border-gray-300 rounded-lg px-4 py-3 focus:ring-2 focus:ring-yellow-500 focus:border-transparent text-center text-lg"
                      placeholder="Enter your password"
                      disabled={loading}
                    />
                  </div>

                  {error && (
                    <div className="bg-red-50 border border-red-200 rounded-lg p-3">
                      <p className="text-red-600 text-sm text-center">{error}</p>
                    </div>
                  )}

                  <button
                    onClick={handleSubmit}
                    disabled={loading}
                    className="w-full bg-yellow-600 text-white py-3 px-4 rounded-lg hover:bg-yellow-700 transition-colors font-medium disabled:opacity-50 disabled:cursor-not-allowed"
                  >
                    {loading ? (
                      <div className="flex items-center justify-center gap-2">
                        <div className="animate-spin rounded-full h-4 w-4 border-b-2 border-white"></div>
                        Connecting...
                      </div>
                    ) : (
                      <>üîì Login to System</>
                    )}
                  </button>
                </div>

                <div className="mt-6 text-center space-y-2">
                  <div className="bg-blue-50 border border-blue-200 rounded-lg p-3">
                    <p className="text-sm font-medium text-blue-900">Demo Credentials:</p>
                    <div className="space-y-1">
                      <p className="text-sm text-blue-700">Username: <span className="font-mono font-bold bg-white px-2 py-1 rounded">Admin</span></p>
                      <p className="text-sm text-blue-700">Password: <span className="font-mono font-bold bg-white px-2 py-1 rounded">TyaLempeng2024!</span></p>
                    </div>
                  </div>
                  <div className="text-xs text-gray-500 space-y-1">
                    <p>üîê Enterprise-grade security with Supabase</p>
                    <p>‚òÅÔ∏è Automatic backups & real-time sync</p>
                    <p>üë• Multi-user collaboration ready</p>
                  </div>
                </div>
              </div>
            </div>
          );
        };

        const FinanceTracker = ({ onLogout, currentUser }) => {
          const [activeTab, setActiveTab] = useState('dashboard');
          const [loading, setLoading] = useState(true);
          const [transactions, setTransactions] = useState([]);
          const [categories, setCategories] = useState({ income: [], expense: [] });
          const [users, setUsers] = useState([]);

          // Load initial data
          useEffect(() => {
            loadData();
          }, []);

          const loadData = async () => {
            try {
              // Load transactions
              const { data: transData } = await supabase
                .from('transactions')
                .select('*')
                .order('created_at', { ascending: false });

              // Load categories
              const { data: catData } = await supabase
                .from('categories')
                .select('*');

              // Load users (if admin)
              const { data: userData } = await supabase
                .from('users')
                .select('*')
                .order('created_date');

              setTransactions(transData || []);

              const categoryMap = { income: [], expense: [] };
              (catData || []).forEach(cat => {
                categoryMap[cat.type].push(cat.name);
              });
              setCategories(categoryMap);

              setUsers(userData || []);
            } catch (error) {
              console.error('Error loading data:', error);
            }
            setLoading(false);
          };

          const calculateTotals = () => {
            const income = transactions.filter(t => t.type === 'income').reduce((sum, t) => sum + t.total_amount, 0);
            const expenses = transactions.filter(t => t.type === 'expense').reduce((sum, t) => sum + t.total_amount, 0);
            const onlineTotal = transactions.filter(t => t.payment_method === 'online').reduce((sum, t) => sum + t.total_amount, 0);
            const cashTotal = transactions.filter(t => t.payment_method === 'cash').reduce((sum, t) => sum + t.total_amount, 0);
            return { income, expenses, balance: income - expenses, onlineTotal, cashTotal };
          };

          const { income, expenses, balance, onlineTotal, cashTotal } = calculateTotals();

          if (loading) {
            return (
              <div className="min-h-screen bg-gray-50 flex items-center justify-center">
                <div className="text-center">
                  <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-yellow-600 mx-auto mb-4"></div>
                  <p className="text-gray-600">Loading your financial data...</p>
                  <p className="text-sm text-gray-500 mt-2">Syncing from secure cloud database</p>
                </div>
              </div>
            );
          }

          const DashboardTab = () => (
            <div className="space-y-6">
              <div className="bg-white rounded-lg shadow-sm p-6">
                <h2 className="text-2xl font-bold text-gray-900 mb-6">Business Overview</h2>

                {/* Data Status */}
                <div className="bg-green-50 p-3 rounded-lg mb-6 border border-green-200">
                  <p className="text-sm text-green-700">
                    ‚òÅÔ∏è <strong>Cloud Database:</strong> Connected to Supabase ‚Ä¢
                    <strong>Transactions:</strong> {transactions.length} ‚Ä¢
                    <strong>Automatic Backups:</strong> Enabled ‚Ä¢
                    <strong>Multi-User:</strong> Active
                  </p>
                </div>

                {/* Summary Cards */}
                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                  <div className="bg-green-50 p-6 rounded-lg border border-green-200">
                    <div className="flex items-center justify-between">
                      <div>
                        <p className="text-green-600 text-sm font-medium">Total Sales</p>
                        <p className="text-3xl font-bold text-green-700">RM {income.toFixed(2)}</p>
                        <p className="text-sm text-green-600 mt-1">
                          {transactions.filter(t => t.type === 'income').length} transactions
                        </p>
                      </div>
                      <TrendingUp className="h-12 w-12 text-green-600" />
                    </div>
                  </div>

                  <div className="bg-red-50 p-6 rounded-lg border border-red-200">
                    <div className="flex items-center justify-between">
                      <div>
                        <p className="text-red-600 text-sm font-medium">Total Expenses</p>
                        <p className="text-3xl font-bold text-red-700">RM {expenses.toFixed(2)}</p>
                        <p className="text-sm text-red-600 mt-1">
                          {transactions.filter(t => t.type === 'expense').length} transactions
                        </p>
                      </div>
                      <TrendingDown className="h-12 w-12 text-red-600" />
                    </div>
                  </div>

                  <div className={`p-6 rounded-lg border ${balance >= 0 ? 'bg-yellow-50 border-yellow-200' : 'bg-red-50 border-red-200'}`}>
                    <div className="flex items-center justify-between">
                      <div>
                        <p className={`text-sm font-medium ${balance >= 0 ? 'text-yellow-600' : 'text-red-600'}`}>Net Balance</p>
                        <p className={`text-3xl font-bold ${balance >= 0 ? 'text-yellow-700' : 'text-red-700'}`}>RM {balance.toFixed(2)}</p>
                        <p className={`text-sm mt-1 ${balance >= 0 ? 'text-yellow-600' : 'text-red-600'}`}>
                          {balance >= 0 ? 'üí∞ Profit' : '‚ö†Ô∏è Loss'}
                        </p>
                      </div>
                      <DollarSign className={`h-12 w-12 ${balance >= 0 ? 'text-yellow-600' : 'text-red-600'}`} />
                    </div>
                  </div>

                  <div className="bg-blue-50 p-6 rounded-lg border border-blue-200">
                    <div className="flex items-center justify-between">
                      <div>
                        <p className="text-blue-600 text-sm font-medium">Online Payments</p>
                        <p className="text-3xl font-bold text-blue-700">RM {onlineTotal.toFixed(2)}</p>
                        <p className="text-sm text-blue-600 mt-1">
                          {transactions.filter(t => t.payment_method === 'online').length} transactions
                        </p>
                      </div>
                      <CreditCard className="h-12 w-12 text-blue-600" />
                    </div>
                  </div>

                  <div className="bg-purple-50 p-6 rounded-lg border border-purple-200">
                    <div className="flex items-center justify-between">
                      <div>
                        <p className="text-purple-600 text-sm font-medium">Cash Payments</p>
                        <p className="text-3xl font-bold text-purple-700">RM {cashTotal.toFixed(2)}</p>
                        <p className="text-sm text-purple-600 mt-1">
                          {transactions.filter(t => t.payment_method === 'cash').length} transactions
                        </p>
                      </div>
                      <DollarSign className="h-12 w-12 text-purple-600" />
                    </div>
                  </div>

                  <div className="bg-indigo-50 p-6 rounded-lg border border-indigo-200">
                    <div className="flex items-center justify-between">
                      <div>
                        <p className="text-indigo-600 text-sm font-medium">Database Status</p>
                        <p className="text-2xl font-bold text-indigo-700">Connected</p>
                        <p className="text-sm text-indigo-600 mt-1">Real-time sync active</p>
                      </div>
                      <Database className="h-12 w-12 text-indigo-600" />
                    </div>
                  </div>
                </div>
              </div>
            </div>
          );

          const tabs = [
            { id: 'dashboard', name: 'Dashboard', icon: BarChart3, description: 'Overview & Analytics' }
          ];

          return (
            <div className="min-h-screen bg-gray-50 flex">
              {/* Left Sidebar */}
              <div className="w-64 bg-white shadow-lg">
                <div className="p-6 border-b">
                  <div className="flex items-center gap-2 mb-2">
                    <Cloud className="h-5 w-5 text-green-600" />
                    <span className="text-sm text-green-600 font-medium">Cloud Database</span>
                  </div>
                  <h1 className="text-xl font-bold text-gray-900">Tya's Lempeng</h1>
                  <p className="text-sm text-gray-600">Financial Tracker Pro</p>
                </div>

                <nav className="p-4">
                  <div className="space-y-2">
                    {tabs.map((tab) => {
                      const IconComponent = tab.icon;
                      return (
                        <button
                          key={tab.id}
                          onClick={() => setActiveTab(tab.id)}
                          className={`w-full flex items-center gap-3 px-4 py-3 rounded-lg text-left transition-colors ${
                            activeTab === tab.id
                              ? 'bg-yellow-100 text-yellow-800 border border-yellow-200'
                              : 'text-gray-600 hover:bg-gray-100'
                          }`}
                        >
                          <IconComponent className="h-5 w-5" />
                          <div>
                            <p className="font-medium">{tab.name}</p>
                            <p className="text-xs opacity-75">{tab.description}</p>
                          </div>
                        </button>
                      );
                    })}
                  </div>

                  {/* System Info */}
                  <div className="mt-4 p-3 bg-green-50 rounded-lg">
                    <p className="text-xs text-green-700 font-medium">System Status</p>
                    <p className="text-sm text-green-800">‚úÖ Database Connected</p>
                    <p className="text-xs text-green-600 mt-1">Supabase PostgreSQL</p>
                  </div>
                </nav>
              </div>

              {/* Main Content */}
              <div className="flex-1 flex flex-col">
                {/* Header */}
                <div className="bg-white shadow-sm border-b px-6 py-4">
                  <div className="flex items-center justify-between">
                    <div>
                      <h2 className="text-xl font-bold text-gray-900 capitalize">{activeTab}</h2>
                      <p className="text-sm text-gray-600">
                        Real-time business analytics powered by cloud database
                      </p>
                    </div>
                    <div className="flex items-center gap-3">
                      <div className="text-right">
                        <p className="text-sm font-medium text-gray-900">{currentUser.username}</p>
                        <p className="text-xs text-gray-500">{currentUser.role}</p>
                      </div>
                      <button
                        onClick={onLogout}
                        className="bg-red-500 text-white px-3 py-2 rounded-lg hover:bg-red-600 flex items-center gap-2 transition-colors text-sm"
                      >
                        <LogOut className="h-4 w-4" />
                        Logout
                      </button>
                    </div>
                  </div>
                </div>

                {/* Page Content */}
                <div className="flex-1 p-6">
                  {activeTab === 'dashboard' && <DashboardTab />}
                </div>
              </div>
            </div>
          );
        };

        const App = () => {
          const [isAuthenticated, setIsAuthenticated] = useState(false);
          const [currentUser, setCurrentUser] = useState(null);

          const handleAuthentication = (user) => {
            setCurrentUser(user);
            setIsAuthenticated(true);
          };

          const handleLogout = () => {
            setCurrentUser(null);
            setIsAuthenticated(false);
          };

          // Check if Supabase is configured
          if (SUPABASE_URL === 'YOUR_SUPABASE_URL' || SUPABASE_ANON_KEY === 'YOUR_SUPABASE_ANON_KEY') {
            return (
              <div className="min-h-screen bg-gradient-to-br from-red-50 to-yellow-50 flex items-center justify-center p-4">
                <div className="bg-white rounded-lg shadow-xl p-8 w-full max-w-2xl">
                  <div className="text-center mb-6">
                    <div className="mx-auto w-20 h-20 bg-red-100 rounded-full flex items-center justify-center mb-4">
                      <Settings className="h-10 w-10 text-red-600" />
                    </div>
                    <h1 className="text-2xl font-bold text-gray-900">Configuration Required</h1>
                    <p className="text-gray-600 mt-2">Please configure your Supabase connection</p>
                  </div>

                  <div className="bg-yellow-50 border border-yellow-200 rounded-lg p-4 mb-6">
                    <h3 className="font-semibold text-yellow-800 mb-2">Required Steps:</h3>
                    <ol className="text-sm text-yellow-700 space-y-1 list-decimal list-inside">
                      <li>Replace <code>YOUR_SUPABASE_URL</code> with your Supabase project URL</li>
                      <li>Replace <code>YOUR_SUPABASE_ANON_KEY</code> with your Supabase anon key</li>
                      <li>Save and refresh the page</li>
                    </ol>
                  </div>

                  <div className="text-sm text-gray-600">
                    <p><strong>Find these in your Supabase dashboard:</strong></p>
                    <p>Settings ‚Üí API ‚Üí Project URL & API Keys</p>
                  </div>
                </div>
              </div>
            );
          }

          if (!isAuthenticated || !currentUser) {
            return <PasswordProtection onAuthenticated={handleAuthentication} />;
          }

          return <FinanceTracker onLogout={handleLogout} currentUser={currentUser} />;
        };

        // Render the app
        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>